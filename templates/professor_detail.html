{% extends 'base.html' %}

{% block title %}{{ professor.name }} - –û—Ü—ñ–Ω–∫–∞{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="container mt-4">
        <!-- –ë–ª–æ–∫ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –≤–∏–∫–ª–∞–¥–∞—á–∞ -->
        <div class="card shadow-sm p-4">
            <div class="row">
                <div class="col-md-4 text-center">
                    <img src="{{ professor.photo.url }}" class="img-fluid rounded" alt="–§–æ—Ç–æ {{ professor.name }}" style="max-width: 200px;">
                </div>
                <div class="col-md-8">
                    <h2>{{ professor.name }}</h2>
                    <p class="text-muted">–ö–∞—Ñ–µ–¥—Ä–∏:
                        {% for department in professor.departments.all %}
                            <a href="{% url 'department_detail' department.id %}" class="badge bg-secondary text-decoration-none">
                                {{ department.name }}
                            </a>
                        {% endfor %}
                    </p>
                    <h4>–°–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥:
                        <span id="average-rating">
                            {{ professor_avg_rating|default:"N/A"|floatformat:1 }}
                        </span> ‚≠ê
                    </h4>

                    <!-- –ö–Ω–æ–ø–∫–∞ "–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è" -->
                    <button class="btn btn-danger mt-2" data-bs-toggle="modal" data-bs-target="#complaintModal">üö® –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</button>
                </div>
            </div>
        </div>
    </div>

    <!-- üî¥ –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –ø–æ–¥–∞–Ω–Ω—è —Å–∫–∞—Ä–≥–∏ -->
    <div class="modal fade" id="complaintModal" tabindex="-1" aria-labelledby="complaintModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="complaintModalLabel">üö® –ü–æ–¥–∞—Ç–∏ —Å–∫–∞—Ä–≥—É</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä–∏—Ç–∏"></button>
                </div>
                <div class="modal-body">
                    <form method="post" action="{% url 'report_professor' professor.id %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="complaintText" class="form-label">–í–∞—à–∞ —Å–∫–∞—Ä–≥–∞:</label>
                            <textarea class="form-control" id="complaintText" name="complaint_text" rows="4" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-danger">üö® –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Å–∫–∞—Ä–≥—É</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- –ë–ª–æ–∫ —Ñ–æ—Ä–º–∏ –≤—ñ–¥–≥—É–∫—É -->
    <div class="card shadow-sm mt-4 p-4">
        <h3 class="mb-3">üìù –ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</h3>
        <form method="post">
            {% csrf_token %}
            <div class="mb-3">
                {{ form.as_p }}
            </div>

            {% if existing_feedback %}
                <button type="submit" class="btn btn-primary" id="review-submit-btn">‚úè –ó–º—ñ–Ω–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</button>
            {% else %}
                <button type="submit" class="btn btn-success" id="review-submit-btn">‚úÖ –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–≥—É–∫</button>
            {% endif %}
        </form>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –≤—ñ–¥–≥—É–∫—ñ–≤ -->
    <h3 class="my-4">üì¢ –í—ñ–¥–≥—É–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</h3>
    {% if feedbacks %}
        <ul class="list-group">
            {% for feedback in feedbacks %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <p>‚≠ê {{ feedback.professionalism }}/5 | üìö {{ feedback.clarity }}/5 | üë• {{ feedback.attitude }}/5</p>
                        <p>{{ feedback.comment }}</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-success like-btn" data-id="{{ feedback.id }}">
                            üëç <span class="like-count">{{ feedback.likes }}</span>
                        </button>
                        <button class="btn btn-outline-danger dislike-btn" data-id="{{ feedback.id }}">
                            üëé <span class="dislike-count">{{ feedback.dislikes }}</span>
                        </button>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-muted">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä—à–∏–º!</p>
    {% endif %}
</div>

<!-- JavaScript –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ -->
<script>
   document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector("form");
        const reviewBtn = document.getElementById("review-submit-btn");

        form.addEventListener("submit", function (event) {
            event.preventDefault();
            let formData = new FormData(form);

            fetch(window.location.href, {
                method: "POST",
                body: formData
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;  // ‚úÖ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                }
            });
        });
    });


        document.querySelectorAll(".like-btn, .dislike-btn").forEach(button => {
            button.addEventListener("click", function () {
                let feedbackId = this.getAttribute("data-id");
                let action = this.classList.contains("like-btn") ? "like" : "dislike";

                fetch(`/feedback/${feedbackId}/${action}/`, { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        this.querySelector("span").textContent = data.count;
                    }
                });
            });
        });
</script>
{% endblock %}
